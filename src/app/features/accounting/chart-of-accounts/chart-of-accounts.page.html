<div class="page-container">
  <!-- Encabezado de la Página -->
  <div class="page-header">
    <h1><i class="fas fa-sitemap"></i> Plan de Cuentas</h1>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="goToAccountForm()">
        <i class="fas fa-plus"></i> Nueva Cuenta
      </button>
    </div>
  </div>

  <!-- Barra de Herramientas y Filtros -->
  <div class="toolbar card">
    <div class="filter-group">
      <label for="version-selector"><i class="fas fa-code-branch"></i> Versión:</label>
      <select id="version-selector" class="form-control"
              [ngModel]="state.selectedVersion()"
              (ngModelChange)="onVersionChange($event)">
        <option *ngIf="state.versions().length === 0" disabled>Cargando...</option>
        <option *ngFor="let v of state.versions()" [value]="v">{{ 'v' + v }}</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="hierarchy-selector"><i class="fas fa-layer-group"></i> Jerarquía:</label>
      <select id="hierarchy-selector" class="form-control"
              [ngModel]="state.selectedHierarchy()"
              (ngModelChange)="onHierarchyChange($event)">
        <option value="LEGAL">Legal</option>
        <option value="MANAGEMENT">Gestión (Management)</option>
        <option value="FISCAL">Fiscal</option>
      </select>
    </div>

    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" placeholder="Buscar por código o nombre..." class="form-control"
             (input)="onSearchTermChange($event)">
    </div>

    <div class="toolbar-actions">
       <button class="btn btn-secondary" title="Importar / Exportar" (click)="goToBulkOperations()"><i class="fas fa-exchange-alt"></i></button>
       <button class="btn btn-secondary" title="Fusionar Cuentas" (click)="goToMergeTool()"><i class="fas fa-code-merge"></i></button>
       <button class="btn btn-secondary" title="Crear Nueva Versión" (click)="createNewVersion()"><i class="fas fa-plus-circle"></i></button>
    </div>
  </div>

  <!-- Contenido Principal: Árbol de Cuentas -->
  <div class="content-area card">
    <!-- Estado de Carga -->
    <div *ngIf="state.isLoading()" class="loading-indicator">
      <i class="fas fa-spinner fa-spin"></i>
      <p>Cargando plan de cuentas...</p>
    </div>

    <!-- Estado de Error -->
    <div *ngIf="!state.isLoading() && state.error()" class="error-message">
      <i class="fas fa-exclamation-triangle"></i>
      <p>{{ state.error() }}</p>
      <button class="btn" (click)="state.refreshAccounts()">Reintentar</button>
    </div>

    <!-- Contenido Principal (cuando no hay carga ni error) -->
    <div *ngIf="!state.isLoading() && !state.error()">
      <div class="account-tree">
        <!-- Encabezado del Árbol/Tabla -->
        <div class="tree-header">
          <div class="col-name">Código y Nombre</div>
          <div class="col-type">Tipo</div>
          <div class="col-nature">Naturaleza</div>
          <div class="col-postable">Imputable</div>
          <div class="col-balance">Balance</div>
          <div class="col-actions">Acciones</div>
        </div>
        <!-- Cuerpo del Árbol/Tabla -->
        <div class="tree-body">
          <ng-container *ngIf="state.displayAccounts().length > 0; else noResults">
            <div *ngFor="let account of state.displayAccounts()" class="tree-row" [class.inactive]="!account.isActive">
              <div class="col-name" [style.paddingLeft.px]="account.level * 25">
                <span class="account-code">{{ account.code }}</span>
                <span class="account-name">{{ account.name }}</span>
              </div>
              <div class="col-type"><span class="badge type-{{account.type.toLowerCase()}}">{{ account.type }}</span></div>
              <div class="col-nature">{{ account.nature }}</div>
              <div class="col-postable">
                <i [class]="account.isPostable ? 'fas fa-check-circle text-success' : 'fas fa-minus-circle text-muted'"></i>
              </div>
              <div class="col-balance">{{ account.balance | currency:'USD':'symbol':'1.2-2' }}</div>
              <div class="col-actions">
                <button class="btn-icon" (click)="goToAccountForm(account.id)" title="Editar Cuenta">
                  <i class="fas fa-pencil-alt"></i>
                </button>
                <!-- Aquí se pueden añadir más acciones en el futuro -->
              </div>
            </div>
          </ng-container>
          
          <!-- Template para cuando no hay resultados -->
          <ng-template #noResults>
            <div class="no-results">
              <p>No se encontraron cuentas que coincidan con los filtros seleccionados.</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
