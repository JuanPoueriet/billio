<header class="page-header">
  <div class="header-left">
    <h1 class="page-title">Plan de Cuentas</h1>

    <div class="action-buttons">
      <!-- Botón de recargar -->
      <button class="btn-icon" (click)="reloadAccounts()" [disabled]="reloading" title="Recargar">
        <lucide-icon [img]="RefreshIcon" [class.spinning]="reloading" size="20">
        </lucide-icon>
      </button>

      <!-- Botón de expandir todo -->
      <button class="btn-icon" (click)="expandAll()" [disabled]="expandingAll" title="Expandir todo">
        <lucide-icon [img]="ExpandAllIcon" size="20"></lucide-icon>
      </button>

      <!-- Botón de colapsar todo -->
      <button class="btn-icon" (click)="collapseAll()" [disabled]="collapsingAll" title="Colapsar todo">
        <lucide-icon [img]="CollapseAllIcon" size="20"></lucide-icon>
      </button>
    </div>
  </div>

  <div class="header-right">
    <!-- Botón para crear nueva cuenta -->
    <button class="btn-primary" (click)="navigateToCreate()">
      <lucide-icon [img]="PlusCircleIcon" size="16"></lucide-icon>
      <span>Nueva Cuenta</span>
    </button>
  </div>
</header>

<section class="controls-section">
  <div class="search-filter">
    <!-- Caja de búsqueda -->
    <div class="search-box">
      <lucide-icon [img]="SearchIcon" size="18"></lucide-icon>
      <input type="text" placeholder="Buscar por código o nombre..." [ngModel]="searchInput"
        (ngModelChange)="onSearchInput()" aria-label="Buscar cuentas">
    </div>

    <!-- Selector de tipo de cuenta -->
    <div class="filter-select">
      <select [ngModel]="selectedType" (ngModelChange)="onTypeChange()" aria-label="Filtrar por tipo de cuenta">
        <option value="all">Todos los tipos</option>
        @for (type of accountTypes; track type) {
        <option [value]="type">{{ accountTypeTranslations[type].es }}</option>
        }
      </select>
    </div>
  </div>
</section>

<section class="page-content">
  <!-- Estado de carga -->
  @if (loading()) {
  <div class="skeleton-container">
    @for (i of [1,2,3,4,5]; track i) {
    <div class="skeleton-row">
      <div class="skeleton-cell name-cell"></div>
      <div class="skeleton-cell type-cell"></div>
      <div class="skeleton-cell balance-cell"></div>
      <div class="skeleton-cell actions-cell"></div>
    </div>
    }
  </div>
  }

  <!-- Estado de error -->
  @if (error()) {
  <div class="error-state">
    <div class="error-icon">
      <lucide-icon [img]="AlertCircleIcon" size="48"></lucide-icon>
    </div>
    <h3>Error al cargar datos</h3>
    <p>{{ error() }}</p>
    <button class="btn-primary" (click)="reloadAccounts()">
      Reintentar
    </button>
  </div>
  }

  <!-- Estado vacío -->
  @if (isEmptyState()) {
  <div class="empty-state">
    <div class="empty-icon">
      <lucide-icon [img]="FileSearchIcon" size="48"></lucide-icon>
    </div>
    <h3>No se encontraron cuentas</h3>
    <p>Intenta cambiar los filtros o crear una nueva cuenta</p>
    <button class="btn-primary" (click)="navigateToCreate()">
      Crear nueva cuenta
    </button>
  </div>
  }

  <!-- Tabla de cuentas -->
  @if (hasAccountsToDisplay()) {
  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th class="col-name">Nombre</th>
          <th class="col-type">Tipo</th>
          <th class="col-balance">Balance</th>
          <th class="col-actions">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @for (account of displayAccounts(); track trackByAccountId($index, account); let i = $index) {
        <tr [class.parent-row]="account.children && account.children.length > 0"
          (click)="onRowClick(account.id, account.children && account.children.length > 0, $event)">
          <td class="name-cell" [style.--level]="account.level">
            <div class="hierarchy-lines">
              @for (line of getHierarchyLines(account.level); track $index) {
              <div class="hierarchy-line" [class.vertical]="line.vertical" [class.horizontal]="line.horizontal"></div>
              }
            </div>

            @if (account.children && account.children.length > 0) {
            <button class="expand-btn" (click)="toggleExpand(account.id); $event.stopPropagation()"
              [attr.aria-label]="account.isExpanded ? 'Contraer cuenta' : 'Expandir cuenta'">
              <lucide-icon [img]="account.isExpanded ? ChevronDownIcon : ChevronRightIcon" size="16">
              </lucide-icon>
            </button>
            }
            @else {
            <div class="expand-placeholder"></div>
            }

            <span class="account-code">{{ account.code }}</span>
            <span class="account-name">{{ account.name }}</span>
          </td>

          <td class="type-cell">
            <span class="account-type">{{ accountTypeTranslations[account.type].es }}</span>
          </td>

          <td class="balance-cell" [class.negative]="account.balance < 0">
            {{ account.balance | currency }}
          </td>

          <td class="actions-cell">
            <button class="btn-icon" (click)="navigateToEdit(account.id, $event)" aria-label="Editar cuenta">
              <lucide-icon [img]="EditIcon" size="16"></lucide-icon>
            </button>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>
  }
</section>